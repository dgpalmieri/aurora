#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define  SHOW_EARTH_AS_BLUE

static float green_table[256][3] = {
{0.000,0.000,0.000},{0.001,0.004,0.003},{0.002,0.008,0.005},{0.004,0.012,0.008},
{0.005,0.015,0.010},{0.006,0.019,0.013},{0.007,0.023,0.015},{0.008,0.027,0.018},
{0.010,0.031,0.020},{0.011,0.034,0.023},{0.012,0.038,0.025},{0.013,0.042,0.028},
{0.014,0.046,0.031},{0.016,0.050,0.033},{0.017,0.054,0.036},{0.018,0.058,0.038},
{0.019,0.061,0.041},{0.021,0.065,0.043},{0.022,0.069,0.046},{0.023,0.073,0.048},
{0.024,0.077,0.051},{0.025,0.080,0.053},{0.027,0.084,0.056},{0.028,0.088,0.058},
{0.029,0.092,0.061},{0.030,0.096,0.064},{0.031,0.100,0.066},{0.033,0.103,0.069},
{0.034,0.107,0.071},{0.035,0.111,0.074},{0.036,0.115,0.076},{0.037,0.119,0.079},
{0.039,0.123,0.081},{0.040,0.126,0.084},{0.041,0.130,0.086},{0.042,0.134,0.089},
{0.044,0.138,0.092},{0.045,0.142,0.094},{0.046,0.146,0.097},{0.047,0.150,0.099},
{0.048,0.153,0.102},{0.050,0.157,0.104},{0.051,0.161,0.107},{0.052,0.165,0.109},
{0.053,0.169,0.112},{0.054,0.173,0.114},{0.056,0.176,0.117},{0.057,0.180,0.119},
{0.058,0.184,0.122},{0.059,0.188,0.125},{0.060,0.192,0.127},{0.062,0.196,0.130},
{0.063,0.199,0.132},{0.064,0.203,0.135},{0.065,0.207,0.137},{0.066,0.211,0.140},
{0.068,0.215,0.142},{0.069,0.219,0.145},{0.070,0.222,0.147},{0.071,0.226,0.150},
{0.073,0.230,0.152},{0.074,0.234,0.155},{0.075,0.238,0.158},{0.076,0.242,0.160},
{0.077,0.245,0.163},{0.079,0.249,0.165},{0.080,0.253,0.168},{0.081,0.257,0.170},
{0.082,0.261,0.173},{0.083,0.265,0.175},{0.085,0.268,0.178},{0.086,0.272,0.180},
{0.087,0.276,0.183},{0.088,0.280,0.186},{0.089,0.284,0.188},{0.091,0.288,0.191},
{0.092,0.291,0.193},{0.093,0.295,0.196},{0.094,0.299,0.198},{0.095,0.303,0.201},
{0.097,0.307,0.203},{0.098,0.310,0.206},{0.099,0.314,0.208},{0.100,0.318,0.211},
{0.102,0.322,0.213},{0.103,0.326,0.216},{0.104,0.330,0.219},{0.105,0.333,0.221},
{0.106,0.337,0.224},{0.108,0.341,0.226},{0.109,0.345,0.229},{0.110,0.349,0.231},
{0.111,0.353,0.234},{0.112,0.356,0.236},{0.114,0.360,0.239},{0.115,0.364,0.241},
{0.116,0.368,0.244},{0.117,0.372,0.247},{0.118,0.376,0.249},{0.120,0.379,0.252},
{0.121,0.383,0.254},{0.122,0.387,0.257},{0.123,0.391,0.259},{0.124,0.395,0.262},
{0.126,0.399,0.264},{0.127,0.402,0.267},{0.128,0.406,0.269},{0.129,0.410,0.272},
{0.131,0.414,0.274},{0.132,0.418,0.277},{0.133,0.422,0.280},{0.134,0.425,0.282},
{0.135,0.429,0.285},{0.137,0.433,0.287},{0.138,0.437,0.290},{0.139,0.441,0.292},
{0.140,0.445,0.295},{0.141,0.448,0.297},{0.143,0.452,0.300},{0.144,0.456,0.302},
{0.145,0.460,0.305},{0.146,0.464,0.308},{0.147,0.468,0.310},{0.149,0.471,0.313},
{0.150,0.475,0.315},{0.151,0.479,0.318},{0.152,0.483,0.320},{0.153,0.487,0.323},
{0.155,0.491,0.325},{0.156,0.494,0.328},{0.157,0.498,0.330},{0.158,0.502,0.333},
{0.160,0.506,0.335},{0.161,0.510,0.338},{0.162,0.514,0.341},{0.163,0.517,0.343},
{0.164,0.521,0.346},{0.166,0.525,0.348},{0.167,0.529,0.351},{0.168,0.533,0.353},
{0.169,0.537,0.356},{0.170,0.540,0.358},{0.172,0.544,0.361},{0.173,0.548,0.363},
{0.174,0.552,0.366},{0.175,0.556,0.369},{0.176,0.560,0.371},{0.178,0.563,0.374},
{0.179,0.567,0.376},{0.180,0.571,0.379},{0.181,0.575,0.381},{0.182,0.579,0.384},
{0.184,0.583,0.386},{0.185,0.586,0.389},{0.186,0.590,0.391},{0.187,0.594,0.394},
{0.189,0.598,0.396},{0.190,0.602,0.399},{0.191,0.606,0.402},{0.192,0.610,0.404},
{0.193,0.613,0.407},{0.195,0.617,0.409},{0.196,0.621,0.412},{0.197,0.625,0.414},
{0.198,0.629,0.417},{0.199,0.633,0.419},{0.201,0.636,0.422},{0.202,0.640,0.424},
{0.203,0.644,0.427},{0.204,0.648,0.430},{0.205,0.652,0.432},{0.207,0.656,0.435},
{0.208,0.659,0.437},{0.209,0.663,0.440},{0.210,0.667,0.442},{0.211,0.671,0.445},
{0.213,0.675,0.447},{0.214,0.679,0.450},{0.215,0.682,0.452},{0.216,0.686,0.455},
{0.218,0.690,0.457},{0.219,0.694,0.460},{0.220,0.698,0.463},{0.221,0.702,0.465},
{0.222,0.705,0.468},{0.224,0.709,0.470},{0.225,0.713,0.473},{0.226,0.717,0.475},
{0.227,0.721,0.478},{0.228,0.725,0.480},{0.230,0.728,0.483},{0.231,0.732,0.485},
{0.232,0.736,0.488},{0.233,0.740,0.491},{0.234,0.744,0.493},{0.236,0.748,0.496},
{0.237,0.751,0.498},{0.238,0.755,0.501},{0.239,0.759,0.503},{0.240,0.763,0.506},
{0.242,0.767,0.508},{0.243,0.771,0.511},{0.244,0.774,0.513},{0.245,0.778,0.516},
{0.247,0.782,0.518},{0.248,0.786,0.521},{0.249,0.790,0.524},{0.250,0.794,0.526},
{0.251,0.797,0.529},{0.253,0.801,0.531},{0.254,0.805,0.534},{0.255,0.809,0.536},
{0.256,0.813,0.539},{0.257,0.817,0.541},{0.259,0.820,0.544},{0.260,0.824,0.546},
{0.261,0.828,0.549},{0.262,0.832,0.552},{0.263,0.836,0.554},{0.265,0.840,0.557},
{0.266,0.843,0.559},{0.267,0.847,0.562},{0.268,0.851,0.564},{0.269,0.855,0.567},
{0.271,0.859,0.569},{0.272,0.863,0.572},{0.273,0.866,0.574},{0.274,0.870,0.577},
{0.276,0.874,0.579},{0.277,0.878,0.582},{0.278,0.882,0.585},{0.279,0.886,0.587},
{0.280,0.889,0.590},{0.282,0.893,0.592},{0.283,0.897,0.595},{0.284,0.901,0.597},
{0.285,0.905,0.600},{0.286,0.909,0.602},{0.288,0.912,0.605},{0.289,0.916,0.607},
{0.290,0.920,0.610},{0.335,0.923,0.634},{0.381,0.927,0.658},{0.426,0.930,0.682},
{0.471,0.933,0.706},{0.517,0.937,0.730},{0.562,0.940,0.754},{0.607,0.943,0.778},
{0.653,0.947,0.802},{0.698,0.950,0.826},{0.743,0.953,0.850},{0.789,0.957,0.874},
{0.834,0.960,0.898},{0.879,0.963,0.922},{0.925,0.967,0.946},{0.970,0.970,0.970} };

static float magenta_table[256][3] = {
{0.000,0.000,0.000},{0.003,0.000,0.003},{0.007,0.000,0.007},{0.010,0.000,0.010},
{0.013,0.000,0.013},{0.017,0.000,0.017},{0.020,0.000,0.020},{0.023,0.000,0.023},
{0.027,0.000,0.027},{0.030,0.000,0.030},{0.033,0.000,0.033},{0.037,0.000,0.037},
{0.040,0.000,0.040},{0.043,0.000,0.043},{0.047,0.000,0.047},{0.050,0.000,0.050},
{0.053,0.000,0.053},{0.057,0.000,0.057},{0.060,0.000,0.060},{0.063,0.000,0.063},
{0.067,0.000,0.067},{0.070,0.000,0.070},{0.073,0.000,0.073},{0.077,0.000,0.077},
{0.080,0.000,0.080},{0.083,0.000,0.083},{0.087,0.000,0.087},{0.090,0.000,0.090},
{0.093,0.000,0.093},{0.097,0.000,0.097},{0.100,0.000,0.100},{0.103,0.000,0.103},
{0.107,0.000,0.107},{0.110,0.000,0.110},{0.113,0.000,0.113},{0.117,0.000,0.117},
{0.120,0.000,0.120},{0.123,0.000,0.123},{0.127,0.000,0.127},{0.130,0.000,0.130},
{0.133,0.000,0.133},{0.137,0.000,0.137},{0.140,0.000,0.140},{0.143,0.000,0.143},
{0.147,0.000,0.147},{0.150,0.000,0.150},{0.153,0.000,0.153},{0.157,0.000,0.157},
{0.160,0.000,0.160},{0.163,0.000,0.163},{0.167,0.000,0.167},{0.170,0.000,0.170},
{0.173,0.000,0.173},{0.177,0.000,0.177},{0.180,0.000,0.180},{0.183,0.000,0.183},
{0.187,0.000,0.187},{0.190,0.000,0.190},{0.193,0.000,0.193},{0.197,0.000,0.197},
{0.200,0.000,0.200},{0.203,0.000,0.203},{0.207,0.000,0.207},{0.210,0.000,0.210},
{0.213,0.000,0.213},{0.217,0.000,0.217},{0.220,0.000,0.220},{0.223,0.000,0.223},
{0.227,0.000,0.227},{0.230,0.000,0.230},{0.233,0.000,0.233},{0.237,0.000,0.237},
{0.240,0.000,0.240},{0.243,0.000,0.243},{0.247,0.000,0.247},{0.250,0.000,0.250},
{0.253,0.000,0.253},{0.257,0.000,0.257},{0.260,0.000,0.260},{0.263,0.000,0.263},
{0.267,0.000,0.267},{0.270,0.000,0.270},{0.273,0.000,0.273},{0.277,0.000,0.277},
{0.280,0.000,0.280},{0.283,0.000,0.283},{0.287,0.000,0.287},{0.290,0.000,0.290},
{0.293,0.000,0.293},{0.297,0.000,0.297},{0.300,0.000,0.300},{0.303,0.000,0.303},
{0.307,0.000,0.307},{0.310,0.000,0.310},{0.313,0.000,0.313},{0.317,0.000,0.317},
{0.320,0.000,0.320},{0.323,0.000,0.323},{0.327,0.000,0.327},{0.330,0.000,0.330},
{0.333,0.000,0.333},{0.337,0.000,0.337},{0.340,0.000,0.340},{0.343,0.000,0.343},
{0.347,0.000,0.347},{0.350,0.000,0.350},{0.353,0.000,0.353},{0.357,0.000,0.357},
{0.360,0.000,0.360},{0.363,0.000,0.363},{0.367,0.000,0.367},{0.370,0.000,0.370},
{0.373,0.000,0.373},{0.377,0.000,0.377},{0.380,0.000,0.380},{0.383,0.000,0.383},
{0.387,0.000,0.387},{0.390,0.000,0.390},{0.393,0.000,0.393},{0.397,0.000,0.397},
{0.400,0.000,0.400},{0.403,0.000,0.403},{0.407,0.000,0.407},{0.410,0.000,0.410},
{0.413,0.000,0.413},{0.417,0.000,0.417},{0.420,0.000,0.420},{0.423,0.000,0.423},
{0.427,0.000,0.427},{0.430,0.000,0.430},{0.433,0.000,0.433},{0.437,0.000,0.437},
{0.440,0.000,0.440},{0.443,0.000,0.443},{0.447,0.000,0.447},{0.450,0.000,0.450},
{0.453,0.000,0.453},{0.457,0.000,0.457},{0.460,0.000,0.460},{0.463,0.000,0.463},
{0.467,0.000,0.467},{0.470,0.000,0.470},{0.473,0.000,0.473},{0.477,0.000,0.477},
{0.480,0.000,0.480},{0.483,0.000,0.483},{0.487,0.000,0.487},{0.490,0.000,0.490},
{0.493,0.000,0.493},{0.497,0.000,0.497},{0.500,0.000,0.500},{0.503,0.000,0.503},
{0.507,0.000,0.507},{0.510,0.000,0.510},{0.513,0.000,0.513},{0.517,0.000,0.517},
{0.520,0.000,0.520},{0.523,0.000,0.523},{0.527,0.000,0.527},{0.530,0.000,0.530},
{0.533,0.000,0.533},{0.537,0.000,0.537},{0.540,0.000,0.540},{0.543,0.000,0.543},
{0.547,0.000,0.547},{0.550,0.000,0.550},{0.553,0.000,0.553},{0.557,0.000,0.557},
{0.560,0.000,0.560},{0.563,0.000,0.563},{0.567,0.000,0.567},{0.570,0.000,0.570},
{0.573,0.000,0.573},{0.577,0.000,0.577},{0.580,0.000,0.580},{0.583,0.000,0.583},
{0.587,0.000,0.587},{0.590,0.000,0.590},{0.593,0.000,0.593},{0.597,0.000,0.597},
{0.600,0.000,0.600},{0.603,0.000,0.603},{0.607,0.000,0.607},{0.610,0.000,0.610},
{0.613,0.000,0.613},{0.617,0.000,0.617},{0.620,0.000,0.620},{0.623,0.000,0.623},
{0.627,0.000,0.627},{0.630,0.000,0.630},{0.633,0.000,0.633},{0.637,0.000,0.637},
{0.640,0.000,0.640},{0.643,0.000,0.643},{0.647,0.000,0.647},{0.650,0.000,0.650},
{0.653,0.000,0.653},{0.657,0.000,0.657},{0.660,0.000,0.660},{0.663,0.000,0.663},
{0.667,0.000,0.667},{0.670,0.000,0.670},{0.673,0.000,0.673},{0.677,0.000,0.677},
{0.680,0.000,0.680},{0.683,0.000,0.683},{0.687,0.000,0.687},{0.690,0.000,0.690},
{0.693,0.000,0.693},{0.697,0.000,0.697},{0.700,0.000,0.700},{0.703,0.000,0.703},
{0.707,0.000,0.707},{0.710,0.000,0.710},{0.713,0.000,0.713},{0.717,0.000,0.717},
{0.720,0.000,0.720},{0.723,0.000,0.723},{0.727,0.000,0.727},{0.730,0.000,0.730},
{0.733,0.000,0.733},{0.737,0.000,0.737},{0.740,0.000,0.740},{0.743,0.000,0.743},
{0.747,0.000,0.747},{0.750,0.000,0.750},{0.753,0.000,0.753},{0.757,0.000,0.757},
{0.760,0.000,0.760},{0.763,0.000,0.763},{0.767,0.000,0.767},{0.770,0.000,0.770},
{0.773,0.000,0.773},{0.777,0.000,0.777},{0.780,0.000,0.780},{0.783,0.000,0.783},
{0.787,0.000,0.787},{0.790,0.000,0.790},{0.793,0.000,0.793},{0.797,0.000,0.797},
{0.800,0.000,0.800},{0.811,0.065,0.811},{0.823,0.129,0.823},{0.834,0.194,0.834},
{0.845,0.259,0.845},{0.857,0.323,0.857},{0.868,0.388,0.868},{0.879,0.453,0.879},
{0.891,0.517,0.891},{0.902,0.582,0.902},{0.913,0.647,0.913},{0.925,0.711,0.925},
{0.936,0.776,0.936},{0.947,0.841,0.947},{0.959,0.905,0.959},{0.970,0.970,0.970} };

main(int argc, char *argv[])
{
  FILE *fp;
  int xres, yres;
  int be_verbose=0;
  int i,x,y,ptr;
  float  min, max;
  float *values;
  float map_min, map_range;
  float alpha;
  float tmpf;
  unsigned char r, g, b;
  int tmp;
  int index;
  int tmpc;

  if (argc != 3 && argc != 5) {
    printf("Usage: %s filename image.ppm [min_map max_map]\n", argv[0]);
    exit(1);
  }

  if ((fp=fopen(argv[1], "rb")) == NULL) {
    printf("Can't open %s\n", argv[1]);
    exit(1);
  }

  if (be_verbose)
    printf("Reading file %s\n", argv[1]);

  if (fscanf(fp, "#FRAW\n%d %d\n", &xres, &yres) != 2) {
    printf("Error reading header\n");
    exit(1);
  }

  if (xres<0 || yres<0) {
    printf("Invalid values in header\n");
    printf("Read xres=%d yres=%d\n", xres, yres);
    exit(1);
  }

  if (be_verbose)
    printf("Resolution = %dx%d\n", xres, yres);

  values = (float *) malloc(xres*yres*sizeof(float));
  if (!values) {
    printf("Can't malloc array to hold values\n");
    exit(1);
  }

  if (fread(values, sizeof(float), xres*yres, fp) != xres*yres) {
    printf("Error reading data\n");
    free(values);
    exit(1);
  }

  if (be_verbose)
    printf("%d bytes (data) read.\n", xres*yres*sizeof(float));

  fclose(fp);

  if (argc == 5) {
    /* use supplied min/max values */
    min = atof(argv[3]);
    max = atof(argv[4]);
    if (min >= max) {
       printf("Invalid range [%lf, %lf]\n", min, max);
       exit(1);
    }
  } else {
    /* find max value */
    min = max = fabs(values[0]) - 1.0;
    for ( i=1 ; i<xres*yres ; i++ ) {
      if ((fabs(values[i])-1.0) > max) max = fabs(values[i])-1.0;
      if ((fabs(values[i])-1.0) < min) min = fabs(values[i])-1.0;
    }
  }
  printf("%s: Range of values for mapping [%lf, %lf]\n", argv[1], min, max);
  map_range = max - min;

  /* write out a ppm file */
  if ((fp = fopen(argv[2], "w")) == 0) {
    printf("Can't open %s\n",argv[2]);
    exit(1);
  }
  fprintf(fp, "P6\n");
  fprintf(fp, "%d %d\n",xres,yres);
  fprintf(fp, "255\n");

  /* flip in y as PPM have 0,0 at upper right */
  for ( y=yres-1 ; y>=0 ; y-- ) {
    for ( x=0 ; x<xres ; x++ ) {
      i = y*xres + x;
      if ((fabs(values[i])-1.0) <= min) alpha = 0.0;
      else if ((fabs(values[i])-1.0) >= max) alpha = 1.0;
      else alpha = (fabs(values[i])-1.0-min) / map_range;
      index = (int) (alpha * 255);
      r = (unsigned char) (255*magenta_table[index][0]);
      g = (unsigned char) (255*magenta_table[index][1]);
      #ifdef SHOW_EARTH_AS_BLUE
        if (values[i] < 0.0) {
          tmpf = magenta_table[index][2] + 0.2;
          if (tmpf > 1.0) b = 255;
          else            b = (unsigned char) (255*tmpf);
        } else {
          b = (unsigned char) (255*magenta_table[index][2]);
        }
      #else
        b = (unsigned char) (255*magenta_table[index][2]);
      #endif
      putc(r,fp); putc(g,fp); putc(b,fp);
    }
  }

  fflush(fp);
  fclose(fp);
 
  free(values);
}
