#include <stdio.h>
#include <stdlib.h>
#include <math.h>

#define  SHOW_EARTH_AS_BLUE

static float green_table[256][3] = {
{0.000,0.000,0.000},{0.001,0.004,0.003},{0.002,0.008,0.005},{0.004,0.012,0.008},
{0.005,0.015,0.010},{0.006,0.019,0.013},{0.007,0.023,0.015},{0.008,0.027,0.018},
{0.010,0.031,0.020},{0.011,0.034,0.023},{0.012,0.038,0.025},{0.013,0.042,0.028},
{0.014,0.046,0.031},{0.016,0.050,0.033},{0.017,0.054,0.036},{0.018,0.058,0.038},
{0.019,0.061,0.041},{0.021,0.065,0.043},{0.022,0.069,0.046},{0.023,0.073,0.048},
{0.024,0.077,0.051},{0.025,0.080,0.053},{0.027,0.084,0.056},{0.028,0.088,0.058},
{0.029,0.092,0.061},{0.030,0.096,0.064},{0.031,0.100,0.066},{0.033,0.103,0.069},
{0.034,0.107,0.071},{0.035,0.111,0.074},{0.036,0.115,0.076},{0.037,0.119,0.079},
{0.039,0.123,0.081},{0.040,0.126,0.084},{0.041,0.130,0.086},{0.042,0.134,0.089},
{0.044,0.138,0.092},{0.045,0.142,0.094},{0.046,0.146,0.097},{0.047,0.150,0.099},
{0.048,0.153,0.102},{0.050,0.157,0.104},{0.051,0.161,0.107},{0.052,0.165,0.109},
{0.053,0.169,0.112},{0.054,0.173,0.114},{0.056,0.176,0.117},{0.057,0.180,0.119},
{0.058,0.184,0.122},{0.059,0.188,0.125},{0.060,0.192,0.127},{0.062,0.196,0.130},
{0.063,0.199,0.132},{0.064,0.203,0.135},{0.065,0.207,0.137},{0.066,0.211,0.140},
{0.068,0.215,0.142},{0.069,0.219,0.145},{0.070,0.222,0.147},{0.071,0.226,0.150},
{0.073,0.230,0.152},{0.074,0.234,0.155},{0.075,0.238,0.158},{0.076,0.242,0.160},
{0.077,0.245,0.163},{0.079,0.249,0.165},{0.080,0.253,0.168},{0.081,0.257,0.170},
{0.082,0.261,0.173},{0.083,0.265,0.175},{0.085,0.268,0.178},{0.086,0.272,0.180},
{0.087,0.276,0.183},{0.088,0.280,0.186},{0.089,0.284,0.188},{0.091,0.288,0.191},
{0.092,0.291,0.193},{0.093,0.295,0.196},{0.094,0.299,0.198},{0.095,0.303,0.201},
{0.097,0.307,0.203},{0.098,0.310,0.206},{0.099,0.314,0.208},{0.100,0.318,0.211},
{0.102,0.322,0.213},{0.103,0.326,0.216},{0.104,0.330,0.219},{0.105,0.333,0.221},
{0.106,0.337,0.224},{0.108,0.341,0.226},{0.109,0.345,0.229},{0.110,0.349,0.231},
{0.111,0.353,0.234},{0.112,0.356,0.236},{0.114,0.360,0.239},{0.115,0.364,0.241},
{0.116,0.368,0.244},{0.117,0.372,0.247},{0.118,0.376,0.249},{0.120,0.379,0.252},
{0.121,0.383,0.254},{0.122,0.387,0.257},{0.123,0.391,0.259},{0.124,0.395,0.262},
{0.126,0.399,0.264},{0.127,0.402,0.267},{0.128,0.406,0.269},{0.129,0.410,0.272},
{0.131,0.414,0.274},{0.132,0.418,0.277},{0.133,0.422,0.280},{0.134,0.425,0.282},
{0.135,0.429,0.285},{0.137,0.433,0.287},{0.138,0.437,0.290},{0.139,0.441,0.292},
{0.140,0.445,0.295},{0.141,0.448,0.297},{0.143,0.452,0.300},{0.144,0.456,0.302},
{0.145,0.460,0.305},{0.146,0.464,0.308},{0.147,0.468,0.310},{0.149,0.471,0.313},
{0.150,0.475,0.315},{0.151,0.479,0.318},{0.152,0.483,0.320},{0.153,0.487,0.323},
{0.155,0.491,0.325},{0.156,0.494,0.328},{0.157,0.498,0.330},{0.158,0.502,0.333},
{0.160,0.506,0.335},{0.161,0.510,0.338},{0.162,0.514,0.341},{0.163,0.517,0.343},
{0.164,0.521,0.346},{0.166,0.525,0.348},{0.167,0.529,0.351},{0.168,0.533,0.353},
{0.169,0.537,0.356},{0.170,0.540,0.358},{0.172,0.544,0.361},{0.173,0.548,0.363},
{0.174,0.552,0.366},{0.175,0.556,0.369},{0.176,0.560,0.371},{0.178,0.563,0.374},
{0.179,0.567,0.376},{0.180,0.571,0.379},{0.181,0.575,0.381},{0.182,0.579,0.384},
{0.184,0.583,0.386},{0.185,0.586,0.389},{0.186,0.590,0.391},{0.187,0.594,0.394},
{0.189,0.598,0.396},{0.190,0.602,0.399},{0.191,0.606,0.402},{0.192,0.610,0.404},
{0.193,0.613,0.407},{0.195,0.617,0.409},{0.196,0.621,0.412},{0.197,0.625,0.414},
{0.198,0.629,0.417},{0.199,0.633,0.419},{0.201,0.636,0.422},{0.202,0.640,0.424},
{0.203,0.644,0.427},{0.204,0.648,0.430},{0.205,0.652,0.432},{0.207,0.656,0.435},
{0.208,0.659,0.437},{0.209,0.663,0.440},{0.210,0.667,0.442},{0.211,0.671,0.445},
{0.213,0.675,0.447},{0.214,0.679,0.450},{0.215,0.682,0.452},{0.216,0.686,0.455},
{0.218,0.690,0.457},{0.219,0.694,0.460},{0.220,0.698,0.463},{0.221,0.702,0.465},
{0.222,0.705,0.468},{0.224,0.709,0.470},{0.225,0.713,0.473},{0.226,0.717,0.475},
{0.227,0.721,0.478},{0.228,0.725,0.480},{0.230,0.728,0.483},{0.231,0.732,0.485},
{0.232,0.736,0.488},{0.233,0.740,0.491},{0.234,0.744,0.493},{0.236,0.748,0.496},
{0.237,0.751,0.498},{0.238,0.755,0.501},{0.239,0.759,0.503},{0.240,0.763,0.506},
{0.242,0.767,0.508},{0.243,0.771,0.511},{0.244,0.774,0.513},{0.245,0.778,0.516},
{0.247,0.782,0.518},{0.248,0.786,0.521},{0.249,0.790,0.524},{0.250,0.794,0.526},
{0.251,0.797,0.529},{0.253,0.801,0.531},{0.254,0.805,0.534},{0.255,0.809,0.536},
{0.256,0.813,0.539},{0.257,0.817,0.541},{0.259,0.820,0.544},{0.260,0.824,0.546},
{0.261,0.828,0.549},{0.262,0.832,0.552},{0.263,0.836,0.554},{0.265,0.840,0.557},
{0.266,0.843,0.559},{0.267,0.847,0.562},{0.268,0.851,0.564},{0.269,0.855,0.567},
{0.271,0.859,0.569},{0.272,0.863,0.572},{0.273,0.866,0.574},{0.274,0.870,0.577},
{0.276,0.874,0.579},{0.277,0.878,0.582},{0.278,0.882,0.585},{0.279,0.886,0.587},
{0.280,0.889,0.590},{0.282,0.893,0.592},{0.283,0.897,0.595},{0.284,0.901,0.597},
{0.285,0.905,0.600},{0.286,0.909,0.602},{0.288,0.912,0.605},{0.289,0.916,0.607},
{0.290,0.920,0.610},{0.335,0.923,0.634},{0.381,0.927,0.658},{0.426,0.930,0.682},
{0.471,0.933,0.706},{0.517,0.937,0.730},{0.562,0.940,0.754},{0.607,0.943,0.778},
{0.653,0.947,0.802},{0.698,0.950,0.826},{0.743,0.953,0.850},{0.789,0.957,0.874},
{0.834,0.960,0.898},{0.879,0.963,0.922},{0.925,0.967,0.946},{0.970,0.970,0.970} };

static float magenta_table[256][3] = {
{0.000,0.000,0.000},{0.004,0.003,0.004},{0.008,0.006,0.008},{0.012,0.009,0.011},
{0.016,0.012,0.015},{0.020,0.015,0.019},{0.024,0.018,0.023},{0.028,0.021,0.027},
{0.032,0.024,0.030},{0.036,0.027,0.034},{0.040,0.030,0.038},{0.044,0.033,0.042},
{0.047,0.036,0.046},{0.051,0.038,0.049},{0.055,0.041,0.053},{0.059,0.044,0.057},
{0.063,0.047,0.061},{0.067,0.050,0.064},{0.071,0.053,0.068},{0.075,0.056,0.072},
{0.079,0.059,0.076},{0.083,0.062,0.080},{0.087,0.065,0.083},{0.091,0.068,0.087},
{0.095,0.071,0.091},{0.099,0.074,0.095},{0.103,0.077,0.099},{0.107,0.080,0.102},
{0.111,0.083,0.106},{0.115,0.086,0.110},{0.119,0.089,0.114},{0.123,0.092,0.118},
{0.127,0.095,0.121},{0.131,0.098,0.125},{0.135,0.101,0.129},{0.139,0.104,0.133},
{0.142,0.107,0.137},{0.146,0.109,0.140},{0.150,0.112,0.144},{0.154,0.115,0.148},
{0.158,0.118,0.152},{0.162,0.121,0.155},{0.166,0.124,0.159},{0.170,0.127,0.163},
{0.174,0.130,0.167},{0.178,0.133,0.171},{0.182,0.136,0.174},{0.186,0.139,0.178},
{0.190,0.142,0.182},{0.194,0.145,0.186},{0.198,0.148,0.190},{0.202,0.151,0.193},
{0.206,0.154,0.197},{0.210,0.157,0.201},{0.214,0.160,0.205},{0.218,0.163,0.209},
{0.222,0.166,0.212},{0.226,0.169,0.216},{0.230,0.172,0.220},{0.234,0.175,0.224},
{0.237,0.177,0.227},{0.241,0.180,0.231},{0.245,0.183,0.235},{0.249,0.186,0.239},
{0.253,0.189,0.243},{0.257,0.192,0.246},{0.261,0.195,0.250},{0.265,0.198,0.254},
{0.269,0.201,0.258},{0.273,0.204,0.262},{0.277,0.207,0.265},{0.281,0.210,0.269},
{0.285,0.213,0.273},{0.289,0.216,0.277},{0.293,0.219,0.281},{0.297,0.222,0.284},
{0.301,0.225,0.288},{0.305,0.228,0.292},{0.309,0.231,0.296},{0.313,0.234,0.300},
{0.317,0.237,0.303},{0.321,0.240,0.307},{0.325,0.243,0.311},{0.329,0.246,0.315},
{0.333,0.248,0.318},{0.336,0.251,0.322},{0.340,0.254,0.326},{0.344,0.257,0.330},
{0.348,0.260,0.334},{0.352,0.263,0.337},{0.356,0.266,0.341},{0.360,0.269,0.345},
{0.364,0.272,0.349},{0.368,0.275,0.353},{0.372,0.278,0.356},{0.376,0.281,0.360},
{0.380,0.284,0.364},{0.384,0.287,0.368},{0.388,0.290,0.372},{0.392,0.293,0.375},
{0.396,0.296,0.379},{0.400,0.299,0.383},{0.404,0.302,0.387},{0.408,0.305,0.391},
{0.412,0.308,0.394},{0.416,0.311,0.398},{0.420,0.314,0.402},{0.424,0.317,0.406},
{0.428,0.319,0.409},{0.431,0.322,0.413},{0.435,0.325,0.417},{0.439,0.328,0.421},
{0.443,0.331,0.425},{0.447,0.334,0.428},{0.451,0.337,0.432},{0.455,0.340,0.436},
{0.459,0.343,0.440},{0.463,0.346,0.444},{0.467,0.349,0.447},{0.471,0.352,0.451},
{0.475,0.355,0.455},{0.479,0.358,0.459},{0.483,0.361,0.463},{0.487,0.364,0.466},
{0.491,0.367,0.470},{0.495,0.370,0.474},{0.499,0.373,0.478},{0.503,0.376,0.482},
{0.507,0.379,0.485},{0.511,0.382,0.489},{0.515,0.385,0.493},{0.519,0.388,0.497},
{0.523,0.390,0.500},{0.526,0.393,0.504},{0.530,0.396,0.508},{0.534,0.399,0.512},
{0.538,0.402,0.516},{0.542,0.405,0.519},{0.546,0.408,0.523},{0.550,0.411,0.527},
{0.554,0.414,0.531},{0.558,0.417,0.535},{0.562,0.420,0.538},{0.566,0.423,0.542},
{0.570,0.426,0.546},{0.574,0.429,0.550},{0.578,0.432,0.554},{0.582,0.435,0.557},
{0.586,0.438,0.561},{0.590,0.441,0.565},{0.594,0.444,0.569},{0.598,0.447,0.573},
{0.602,0.450,0.576},{0.606,0.453,0.580},{0.610,0.456,0.584},{0.614,0.459,0.588},
{0.618,0.461,0.591},{0.621,0.464,0.595},{0.625,0.467,0.599},{0.629,0.470,0.603},
{0.633,0.473,0.607},{0.637,0.476,0.610},{0.641,0.479,0.614},{0.645,0.482,0.618},
{0.649,0.485,0.622},{0.653,0.488,0.626},{0.657,0.491,0.629},{0.661,0.494,0.633},
{0.665,0.497,0.637},{0.669,0.500,0.641},{0.673,0.503,0.645},{0.677,0.506,0.648},
{0.681,0.509,0.652},{0.685,0.512,0.656},{0.689,0.515,0.660},{0.693,0.518,0.664},
{0.697,0.521,0.667},{0.701,0.524,0.671},{0.705,0.527,0.675},{0.709,0.530,0.679},
{0.713,0.532,0.683},{0.716,0.535,0.686},{0.720,0.538,0.690},{0.724,0.541,0.694},
{0.728,0.544,0.698},{0.732,0.547,0.701},{0.736,0.550,0.705},{0.740,0.553,0.709},
{0.744,0.556,0.713},{0.748,0.559,0.717},{0.752,0.562,0.720},{0.756,0.565,0.724},
{0.760,0.568,0.728},{0.764,0.571,0.732},{0.768,0.574,0.736},{0.772,0.577,0.739},
{0.776,0.580,0.743},{0.780,0.583,0.747},{0.784,0.586,0.751},{0.788,0.589,0.755},
{0.792,0.592,0.758},{0.796,0.595,0.762},{0.800,0.598,0.766},{0.804,0.601,0.770},
{0.808,0.604,0.774},{0.811,0.606,0.777},{0.815,0.609,0.781},{0.819,0.612,0.785},
{0.823,0.615,0.789},{0.827,0.618,0.792},{0.831,0.621,0.796},{0.835,0.624,0.800},
{0.839,0.627,0.804},{0.843,0.630,0.808},{0.847,0.633,0.811},{0.851,0.636,0.815},
{0.855,0.639,0.819},{0.859,0.642,0.823},{0.863,0.645,0.827},{0.867,0.648,0.830},
{0.871,0.651,0.834},{0.875,0.654,0.838},{0.879,0.657,0.842},{0.883,0.660,0.846},
{0.887,0.663,0.849},{0.891,0.666,0.853},{0.895,0.669,0.857},{0.899,0.672,0.861},
{0.903,0.675,0.865},{0.906,0.677,0.868},{0.910,0.680,0.872},{0.914,0.683,0.876},
{0.918,0.686,0.880},{0.922,0.689,0.883},{0.926,0.692,0.887},{0.930,0.695,0.891},
{0.934,0.698,0.895},{0.938,0.701,0.899},{0.942,0.704,0.902},{0.946,0.707,0.906},
{0.950,0.710,0.910},{0.951,0.727,0.914},{0.953,0.745,0.918},{0.954,0.762,0.922},
{0.955,0.779,0.926},{0.957,0.797,0.930},{0.958,0.814,0.934},{0.959,0.831,0.938},
{0.961,0.849,0.942},{0.962,0.866,0.946},{0.963,0.883,0.950},{0.965,0.901,0.954},
{0.966,0.918,0.958},{0.967,0.935,0.962},{0.969,0.953,0.966},{0.970,0.970,0.970}};

static float red_table[256][3] = {
{0.000,0.000,0.000},{0.004,0.001,0.000},{0.008,0.002,0.001},{0.012,0.002,0.001},
{0.015,0.003,0.001},{0.019,0.004,0.002},{0.023,0.005,0.002},{0.027,0.005,0.002},
{0.031,0.006,0.003},{0.034,0.007,0.003},{0.038,0.008,0.003},{0.042,0.008,0.004},
{0.046,0.009,0.004},{0.050,0.010,0.004},{0.054,0.010,0.005},{0.058,0.011,0.005},
{0.061,0.012,0.005},{0.065,0.013,0.006},{0.069,0.013,0.006},{0.073,0.014,0.006},
{0.077,0.015,0.006},{0.080,0.016,0.007},{0.084,0.016,0.007},{0.088,0.017,0.007},
{0.092,0.018,0.008},{0.096,0.019,0.008},{0.100,0.019,0.008},{0.103,0.020,0.009},
{0.107,0.021,0.009},{0.111,0.022,0.009},{0.115,0.022,0.010},{0.119,0.023,0.010},
{0.123,0.024,0.010},{0.126,0.025,0.011},{0.130,0.025,0.011},{0.134,0.026,0.011},
{0.138,0.027,0.012},{0.142,0.028,0.012},{0.146,0.028,0.012},{0.150,0.029,0.013},
{0.153,0.030,0.013},{0.157,0.031,0.013},{0.161,0.031,0.014},{0.165,0.032,0.014},
{0.169,0.033,0.014},{0.173,0.034,0.015},{0.176,0.034,0.015},{0.180,0.035,0.015},
{0.184,0.036,0.016},{0.188,0.037,0.016},{0.192,0.038,0.016},{0.196,0.038,0.017},
{0.199,0.039,0.017},{0.203,0.040,0.017},{0.207,0.041,0.018},{0.211,0.041,0.018},
{0.215,0.042,0.018},{0.219,0.043,0.019},{0.222,0.044,0.019},{0.226,0.044,0.019},
{0.230,0.045,0.019},{0.234,0.046,0.020},{0.238,0.047,0.020},{0.242,0.047,0.020},
{0.245,0.048,0.021},{0.249,0.049,0.021},{0.253,0.050,0.021},{0.257,0.050,0.022},
{0.261,0.051,0.022},{0.265,0.052,0.022},{0.268,0.053,0.023},{0.272,0.053,0.023},
{0.276,0.054,0.023},{0.280,0.055,0.024},{0.284,0.056,0.024},{0.288,0.056,0.024},
{0.291,0.057,0.025},{0.295,0.058,0.025},{0.299,0.059,0.025},{0.303,0.059,0.026},
{0.307,0.060,0.026},{0.310,0.061,0.026},{0.314,0.062,0.027},{0.318,0.062,0.027},
{0.322,0.063,0.027},{0.326,0.064,0.028},{0.330,0.065,0.028},{0.333,0.065,0.028},
{0.337,0.066,0.029},{0.341,0.067,0.029},{0.345,0.068,0.029},{0.349,0.068,0.030},
{0.353,0.069,0.030},{0.356,0.070,0.030},{0.360,0.071,0.031},{0.364,0.071,0.031},
{0.368,0.072,0.031},{0.372,0.073,0.032},{0.376,0.074,0.032},{0.379,0.074,0.032},
{0.383,0.075,0.032},{0.387,0.076,0.033},{0.391,0.077,0.033},{0.395,0.077,0.033},
{0.399,0.078,0.034},{0.402,0.079,0.034},{0.406,0.080,0.034},{0.410,0.080,0.035},
{0.414,0.081,0.035},{0.418,0.082,0.035},{0.422,0.082,0.036},{0.425,0.083,0.036},
{0.429,0.084,0.036},{0.433,0.085,0.037},{0.437,0.085,0.037},{0.441,0.086,0.037},
{0.445,0.087,0.038},{0.448,0.088,0.038},{0.452,0.088,0.038},{0.456,0.089,0.039},
{0.460,0.090,0.039},{0.464,0.091,0.039},{0.468,0.091,0.040},{0.471,0.092,0.040},
{0.475,0.093,0.040},{0.479,0.094,0.041},{0.483,0.094,0.041},{0.487,0.095,0.041},
{0.491,0.096,0.042},{0.494,0.097,0.042},{0.498,0.097,0.042},{0.502,0.098,0.043},
{0.506,0.099,0.043},{0.510,0.100,0.043},{0.514,0.100,0.044},{0.517,0.101,0.044},
{0.521,0.102,0.044},{0.525,0.103,0.045},{0.529,0.103,0.045},{0.533,0.104,0.045},
{0.537,0.105,0.046},{0.540,0.106,0.046},{0.544,0.106,0.046},{0.548,0.107,0.046},
{0.552,0.108,0.047},{0.556,0.109,0.047},{0.560,0.109,0.047},{0.563,0.110,0.048},
{0.567,0.111,0.048},{0.571,0.112,0.048},{0.575,0.112,0.049},{0.579,0.113,0.049},
{0.583,0.114,0.049},{0.586,0.115,0.050},{0.590,0.115,0.050},{0.594,0.116,0.050},
{0.598,0.117,0.051},{0.602,0.118,0.051},{0.606,0.118,0.051},{0.610,0.119,0.052},
{0.613,0.120,0.052},{0.617,0.121,0.052},{0.621,0.121,0.053},{0.625,0.122,0.053},
{0.629,0.123,0.053},{0.633,0.124,0.054},{0.636,0.124,0.054},{0.640,0.125,0.054},
{0.644,0.126,0.055},{0.648,0.127,0.055},{0.652,0.127,0.055},{0.656,0.128,0.056},
{0.659,0.129,0.056},{0.663,0.130,0.056},{0.667,0.130,0.057},{0.671,0.131,0.057},
{0.675,0.132,0.057},{0.679,0.133,0.058},{0.682,0.133,0.058},{0.686,0.134,0.058},
{0.690,0.135,0.059},{0.694,0.136,0.059},{0.698,0.136,0.059},{0.702,0.137,0.059},
{0.705,0.138,0.060},{0.709,0.139,0.060},{0.713,0.139,0.060},{0.717,0.140,0.061},
{0.721,0.141,0.061},{0.725,0.142,0.061},{0.728,0.142,0.062},{0.732,0.143,0.062},
{0.736,0.144,0.062},{0.740,0.145,0.063},{0.744,0.146,0.063},{0.748,0.146,0.063},
{0.751,0.147,0.064},{0.755,0.148,0.064},{0.759,0.149,0.064},{0.763,0.149,0.065},
{0.767,0.150,0.065},{0.771,0.151,0.065},{0.774,0.152,0.066},{0.778,0.152,0.066},
{0.782,0.153,0.066},{0.786,0.154,0.067},{0.790,0.155,0.067},{0.794,0.155,0.067},
{0.797,0.156,0.068},{0.801,0.157,0.068},{0.805,0.158,0.068},{0.809,0.158,0.069},
{0.813,0.159,0.069},{0.817,0.160,0.069},{0.820,0.161,0.070},{0.824,0.161,0.070},
{0.828,0.162,0.070},{0.832,0.163,0.071},{0.836,0.164,0.071},{0.840,0.164,0.071},
{0.843,0.165,0.072},{0.847,0.166,0.072},{0.851,0.167,0.072},{0.855,0.167,0.072},
{0.859,0.168,0.073},{0.863,0.169,0.073},{0.866,0.170,0.073},{0.870,0.170,0.074},
{0.874,0.171,0.074},{0.878,0.172,0.074},{0.882,0.173,0.075},{0.886,0.173,0.075},
{0.889,0.174,0.075},{0.893,0.175,0.076},{0.897,0.176,0.076},{0.901,0.176,0.076},
{0.905,0.177,0.077},{0.909,0.178,0.077},{0.912,0.179,0.077},{0.916,0.179,0.078},
{0.920,0.180,0.078},{0.923,0.233,0.137},{0.927,0.285,0.197},{0.930,0.338,0.256},
{0.933,0.391,0.316},{0.937,0.443,0.375},{0.940,0.496,0.435},{0.943,0.549,0.494},
{0.947,0.601,0.554},{0.950,0.654,0.613},{0.953,0.707,0.673},{0.957,0.759,0.732},
{0.960,0.812,0.792},{0.963,0.865,0.851},{0.967,0.917,0.911},{0.970,0.970,0.970}};

#define NUM_CHANNELS 3
char *channels[NUM_CHANNELS] = { "green", "magenta", "red" };

/***** use to create a gamma table *****/
#define GAMMA_SIZE 256
static unsigned int gamma_table[GAMMA_SIZE];

void set_gamma(n, gamma, gain)
int    n;
double gamma;
double gain;
{
  int    i;
  int    up_limit;
  double max_val;
  double one_over_gamma;

  if (n > GAMMA_SIZE) {
    printf("Need to increase the size of GAMMA_SIZE\n");
    exit(1);
  }

  up_limit       = n-1;
  max_val        = (double) up_limit;
  one_over_gamma = 1.0 / gamma;
  for ( i=0 ; i<n ; i++ ) {
    gamma_table[i] = up_limit*pow(i/max_val*gain,one_over_gamma);
    #if 1
      printf("%d: %d\n",i,gamma_table[i]);
    #endif
  }

}


main(int argc, char *argv[])
{
  FILE *fp;
  int xres=-1;
  int yres=-1;
  int tmpxres;
  int tmpyres;
  int be_verbose=0;
  int i,c,x,y,ptr;
  float min[NUM_CHANNELS];
  float max[NUM_CHANNELS];
  float map_range[NUM_CHANNELS];
  float *values = NULL;
  float *raster = NULL;
  float alpha;
  float tmpf;
  unsigned char r, g, b;
  int tmp;
  int index;
  int tmpc;
  char infilename[256];
  int  calc_min_max = 1;
  double gamma;
#ifdef SHOW_EARTH_AS_BLUE
  int not_added=1;
#endif
  int max_entry;

  if (argc != 4 && argc != 10) {
    printf("Usage: %s filebase out.ppm gamma [Gmin Gmax Mmin Mmax Rmin Rmax]\n",
           argv[0]);
    exit(1);
  }

  gamma = atof(argv[3]);
  if (gamma <= 0.0) {
    printf("Gamma (%lf) must be > 0.0\n", gamma);
    exit(1);
  }
  max_entry = GAMMA_SIZE-1;
  set_gamma(GAMMA_SIZE, gamma, 1.0);

  if (argc == 10) {
    calc_min_max = 0;
    min[0] = atof(argv[4]);
    max[0] = atof(argv[5]);
    min[1] = atof(argv[6]);
    max[1] = atof(argv[7]);
    min[2] = atof(argv[8]);
    max[2] = atof(argv[9]);
    if (min >= max) {
       printf("Invalid range [%lf, %lf]\n", min, max);
       exit(1);
    }
  }

  for ( c=0 ; c<NUM_CHANNELS ; c++ ) {

    sprintf(infilename, "%s.%s", argv[1], channels[c]);

    if ((fp=fopen(infilename, "rb")) == NULL)
      { printf("%s not found\n", infilename); continue; }

    if (be_verbose) printf("Reading file %s\n", infilename);

    if (fscanf(fp, "#FRAW\n%d %d\n", &tmpxres, &tmpyres) != 2) {
      printf("Error reading header\n");
      exit(1);
    }

    if (xres < 0) {

      /* haven't been set yet */
      if (tmpxres<1 || tmpyres<1) {
        printf("Invalid values in header\n");
        printf("Read xres=%d yres=%d\n", tmpxres, tmpyres);
        exit(1);
      }

      /* set them */
      xres = tmpxres;
      yres = tmpyres;

    } else {

      /* verify these are the same */
      if (xres != tmpxres || yres != tmpyres) {
        printf("Raster resolutions do not match\n");
        exit(1);
      }

    }

    if (be_verbose)
      printf("Resolution = %dx%d\n", xres, yres);

    if (!values) {

      /* need to malloc memory to hold input energy */
      values = (float *) malloc(xres*yres*sizeof(float));
      if (!values) {
        printf("Can't malloc array to hold values\n");
        exit(1);
      }

    }

    if (fread(values, sizeof(float), xres*yres, fp) != xres*yres) {
      printf("Error reading data\n");
      free(values);
      exit(1);
    }

    fclose(fp);

    if (be_verbose)
      printf("%d bytes (data) read.\n", xres*yres*sizeof(float));

    if (calc_min_max) {
      min[c] = max[c] = fabs(values[0]) - 1.0;
      for ( i=1 ; i<xres*yres ; i++ ) {
        if ((fabs(values[i])-1.0) > max[c]) max[c] = fabs(values[i])-1.0;
        if ((fabs(values[i])-1.0) < min[c]) min[c] = fabs(values[i])-1.0;
      }
    }
    printf("%s: Range of values for mapping [%lf, %lf]\n", infilename, min[c], max[c]);
    map_range[c] = max[c] - min[c];

    if (!raster) {
      /* allocate memory for a floating point raster */
      raster = (float *) malloc(3*xres*yres*sizeof(float));
      if (!raster)
        { printf("Can't malloc array to hold raster\n"); exit(1); }
      for ( i=0 ; i<3*xres*yres ; i++ )
        raster[i] = 0.0;
    }

    /* add this energy to the raster */
    for ( i=0 ; i<xres*yres ; i++ ) {
      if ((fabs(values[i])-1.0) <= min[c]) alpha = 0.0;
      else if ((fabs(values[i])-1.0) >= max[c]) alpha = 1.0;
      else alpha = (fabs(values[i])-1.0-min[c]) / map_range[c];
      index = gamma_table[(int) (max_entry * alpha)];
      if (c==0) {
        raster[3*i]   += green_table[index][0];
        raster[3*i+1] += green_table[index][1];
        raster[3*i+2] += green_table[index][2];
      } else if (c==1) {
        raster[3*i]   += magenta_table[index][0];
        raster[3*i+1] += magenta_table[index][1];
        raster[3*i+2] += magenta_table[index][2];
      } else if (c==2) {
        raster[3*i]   += red_table[index][0];
        raster[3*i+1] += red_table[index][1];
        raster[3*i+2] += red_table[index][2];
      }

      #ifdef SHOW_EARTH_AS_BLUE
      if (not_added) {
        if (values[i] < 0.0) raster[3*i+2] += 0.2;
      }
      #endif

    }

  #ifdef SHOW_EARTH_AS_BLUE
    not_added=0;
  #endif

  } /* end for c */

  /* write out a ppm file */
  if ((fp = fopen(argv[2], "w")) == 0) {
    printf("Can't open %s\n",argv[2]);
    exit(1);
  }
  fprintf(fp, "P6\n");
  fprintf(fp, "%d %d\n",xres,yres);
  fprintf(fp, "255\n");

  /* flip in y as PPM have 0,0 at upper right */
  for ( y=yres-1 ; y>=0 ; y-- ) {
    for ( x=0 ; x<xres ; x++ ) {
      i = y*xres + x;
      if (raster[3*i] <= 0.0)        r = (unsigned char) 0;
      else if (raster[3*i] >= 1.0)   r = (unsigned char) 255;
      else                           r = (unsigned char) (255*raster[3*i]);
      if (raster[3*i+1] <= 0.0)      g = (unsigned char) 0;
      else if (raster[3*i+1] >= 1.0) g = (unsigned char) 255;
      else                           g = (unsigned char) (255*raster[3*i+1]);
      if (raster[3*i+2] <= 0.0)      b = (unsigned char) 0;
      else if (raster[3*i+2] >= 1.0) b = (unsigned char) 255;
      else                           b = (unsigned char) (255*raster[3*i+2]);
      putc(r,fp);
      putc(g,fp);
      putc(b,fp);
    }
  }
  fflush(fp);
  fclose(fp);
 
  free(raster);
  free(values);
}
